<% if @user && @user.is_moderator? && @story.is_gone? %>
  <%= render partial: 'stories/missing' %>
  <hr class="mod">
  <p>Full display for submitter and mods:</p>
<% end %>
<ol class="stories">
  <%= render :partial => "stories/listdetail",
    :locals => { :story => @story, :single_story => true } %>
</ol>

<div class="story_content">
  <% if @story.markeddown_description.present? %>
    <div class="story_text">
      <%= raw @story.markeddown_description %>
    </div>
  <% end %>

  <% if @story.is_unavailable %>
    <% StoryText.cached?(@story) do |text| %>
      <a class="story_text_expander">Source URL considered unavailable as of
      <%= time_ago_in_words_label(@story.unavailable_at) %>, click for cached text - also see archive links above</a>
      <div id="collapsed_story_text">
        <p>
        <em>All story content copyright of its respective owner.</em>
        </p>

        <div class="story_text">
          <blockquote>
            <%= simple_format(text) %>
          </blockquote>
        </div>
      </div>

    <% end %>
  <% end %>
</div>

<% if !@story.previewing %>
  <ol class="comments comments1">
    <% if !@story.is_gone? && !@story.previewing && @story.accepting_comments? %>
      <li class="comments_subtree"><%= render "comments/commentbox", :comment => @comment %></li>
    <% end %>

    <li class="comments_subtree">
      <% previous_depth = 0 %>
      <% @comments.each do |comment| %>

        <% if comment.depth > previous_depth %>
          <ol class="comments">
            <li class="comments_subtree">
        <% else %>
          <% (previous_depth - comment.depth).times do %>
              </li>
            </ol>
          <% end %>
        <% end %>
        <% previous_depth = comment.depth %>

        <%= render "comments/comment", :comment => comment,
          :show_story => (comment.story_id != @story.id),
          :show_tree_lines => true,
          :was_merged => (comment.story_id != @story.id),
          :children => [],
          :is_unread => is_unread?(comment) %>

        <%#
	#  If you edit this structure, update the incredibly brittle css selector
        #    li.comments_subtree > .comment:nth-last-of-type(2) .comment_parent_tree_line
        #  (or refactor the whole parent/sibling lines implementation)
        #%>
        <% if comment.depth != 0 %>
          <div class="comment_siblings_tree_line"></div>
        <% end %>

      <% end %>
    </li>

  </ol>
<% end %>

<% if !@story.previewing && @story.public_similar_stories(@user).any? %>
  <div class="box wide">
    <h4>Stories with similar links:</h4>
    <%= render partial: "stories/similar", locals: { similar: @story.public_similar_stories(@user) } %>
  </div>
<% end %>
